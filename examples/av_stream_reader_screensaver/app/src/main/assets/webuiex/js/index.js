import*as Deep from"../libs/deep-es6-1.1.0.min.js";(()=>{const e="tech.qeedji.av_stream_reader_screensaver",t="tech.qeedji.av_stream_reader_screensaver.prefs",s="tech.qeedji.av_stream_reader_screensaver.credential",i=`${t}/start_after_boot_completed`,n=`${t}/autorefresh_url_enabled`,l=`${t}/autorefresh_url_interval`,r=`${t}/url`,a=`${t}/credential`,o=`/odata.qs/v1/AppPreferencesAdmin.${e}`,d=`/odata.qs/v1/$metadata#AppPreferencesAdmin.${e}`,h="ui-state-hidden",u=`${e}.form.edit`,c=`${e}.passsword.edit`,p="message";class m{lang;locale;startAfterBootCompleted=!1;autorefreshUrlEnabled=!1;autorefreshUrlInterval=0;url="";connectionAccounts=[];connectionAccount;urlExample="udp://239.1.2.3:1234, udp://192.168.1.23:1234";credential={credential:"",type:""};oldCredentialMap=new Map;hidePassword(){"HttpAuth"===this.credential.type&&this.credential.password&&(this.credential.password.value="",this.credential.password.crypted=!0)}parse(e,t){try{if(e["@odata.context"]===t){this.connectionAccount=0!=this.connectionAccounts.length?this.connectionAccounts[0].id:void 0,this.credential||(this.credential={credential:"",type:""});for(const t of e.value)if(null!=t&&null!=t.Name)switch(t.Name){case i:this.startAfterBootCompleted=t.Value;break;case n:this.autorefreshUrlEnabled=t.Value||!1;break;case l:this.autorefreshUrlInterval=1e3*t.Value;break;case r:this.url=t.Value;break;case a:this.credential.credential=t.Value}}}catch(e){throw e instanceof TypeError?e:new Error("An error occured in the data parsing.")}}isUsernameChanged(e){let t=!1;return"HttpAuth"===this.credential.type&&(t=this.credential.username!==e.credential.username),t}isPasswordChanged(){let e=!1;return"HttpAuth"===this.credential.type&&(e=!this.credential.password.crypted&&0!==this.credential.password.value.length),e}getJsonPref(e){let t;const o=`${s}.${this.credential.credential}.prefs/type`,d=`${s}.${this.credential.credential}.prefs/username`,h=`${s}.${this.credential.credential}.prefs/password`;switch(e){case i:t={"@odata.type":"Preferences.BooleanValue",Value:this.startAfterBootCompleted};break;case n:t={"@odata.type":"Preferences.BooleanValue",Value:this.autorefreshUrlEnabled};break;case l:t={"@odata.type":"Preferences.LongValue",Value:Math.floor(this.autorefreshUrlInterval/1e3)};break;case r:default:t={"@odata.type":"Preferences.StringValue",Value:this.url};break;case a:t={"@odata.type":"Preferences.StringValue",Value:this.credential.credential};break;case o:t={"@odata.type":"Preferences.StringValue",Value:this.credential.type};break;case d:t="HttpAuth"===this.credential.type?{"@odata.type":"Preferences.StringValue",Value:this.credential.username}:{"@odata.type":"Preferences.StringValue",Value:""};break;case h:if("HttpAuth"===this.credential.type){t={"@odata.type":"Preferences.StringValue",Value:this.credential.password.value}}else t={"@odata.type":"Preferences.StringValue",Value:""}}return t}clone(){const e=Deep.deepClone(this,{makeWritable:!0});return delete e.lang,delete e.locale,e.oldCredentialMap.clear(),e}setCurrentCredentialToCredentialMap(){this.oldCredentialMap.values.length&&this.oldCredentialMap.clear(),this.credential&&this.oldCredentialMap.set(this.credential.type,this.credential)}encryp(e){return e}equals(e){const t=this.clone();return Deep.deepCompare(e,t)}}class w{model;#e;#t;#s;#i;#n=null;#l=null;#r=null;#a;#o;#d;#h;constructor(e,t,s,i,n){this.model=i,this.#e=e,this.#t=t,this.#s=s,this.#a=n,this.#o=this.#u.bind(this),this.#d=this.#c.bind(this),this.#h=this.#p.bind(this)}checkValid(){let e=!0;return null==this.#n||null==this.#a||null==this.model||this.model.crypted||(this.#n.required&&this.#n.validity.valueMissing?(this.#n.setCustomValidity(this.#a["Please enter the password."]),e=!1):this.#n.setCustomValidity("")),e}destroy(){this.#m(),this.#w()}initialize(){this.#f(),this.#v()}setLocale(e){this.#a=e,this.#i=this.#a["Password saved"]}setModel(e){this.model=e}updateEditor(){null!=this.model&&(this.model.crypted?this.#I():this.#E())}#f(){this.#n=document.getElementById(this.#e),this.#l=document.getElementById(this.#t),this.#r=document.getElementById(this.#s),this.#m(),this.#I()}#v(){null!=this.#n&&this.#n.addEventListener("input",this.#o),null!=this.#l&&this.#l.addEventListener("click",this.#d),null!=this.#r&&this.#r.addEventListener("click",this.#h)}#g(){const e=null!=this.model?this.model.value:"",t=null==this.model||this.model.crypted,s=new CustomEvent(c,{detail:{value:e,crypted:t}});window.dispatchEvent(s)}#I(){null!=this.#n&&(this.#n.readOnly=!0,this.#n.required=!1,this.#n.type="text"),this.#y(),this.#l&&(this.#l.disabled=!0),this.#r&&(this.#r.disabled=!1)}#E(){null!=this.#n&&(this.model?this.#n.value=this.model.value:this.#n.value="",this.#n.removeAttribute("readonly"),this.#n.required=!0),null!=this.#l&&(this.#l.disabled=!1),null!=this.#r&&(this.#r.disabled=!0)}#u(e){null!=this.#n&&(this.model?(this.model.value=this.#n.value,this.model.crypted=!1):this.model={crypted:!1,value:this.#n.value},this.#g())}#p(e){e.stopImmediatePropagation(),e.stopPropagation(),this.model?(this.model.value="",this.model.crypted=!1):this.model={crypted:!1,value:""},null!=this.#n&&(this.#n.type="password",this.#n.value="",this.#n.required=!0,this.#n.removeAttribute("readonly")),null!=this.#l&&(this.#l.disabled=!1),this.#g(),setTimeout((()=>{null!=this.#r&&(this.#r.disabled=!0)}),100)}#c(e){if(null!=this.#n){const e="password"===this.#n.type;this.#n.type=e?"text":"password";const t=!e;null!=this.#l&&(t?(this.#l.classList.contains(h)&&this.#l.classList.remove(h),null!=this.#a&&"View password"in this.#a&&(this.#l.title=this.#a["View password"])):(this.#l.classList.contains(h)||this.#l.classList.add(h),null!=this.#a&&"Hide password"in this.#a&&(this.#l.title=this.#a["Hide password"])))}}#m(){null!=this.#n&&this.#n.setCustomValidity("")}#y(){null!=this.#n&&null!=this.model&&this.model.crypted&&(this.#n.value=this.#i?`(${this.#i})`:"")}#w(){null!=this.#n&&this.#n.removeEventListener("input",this.#o),null!=this.#l&&this.#l.removeEventListener("click",this.#d),null!=this.#r&&this.#r.removeEventListener("click",this.#h)}}class f{startModel;isModified=!1;#b=null;#P=null;#C=null;#A=null;#M=null;#U=null;#L=null;#H=null;#S=null;#x=null;#k=null;#V;#B;#T;#$;#R;#F;#q;#o;#O;#j;#z;#D;#J;constructor(e){this.#D=e,this.#V=["","HttpAuth"],this.#B={"":"None",HttpAuth:"Identifier/Password"},this.#T={"web-site":"Simple web server"},this.#$=this.#N.bind(this),this.#F=this.#_.bind(this),this.#R=this.#G.bind(this),this.#q=this.#W.bind(this),this.#o=this.#u.bind(this),this.#O=this.#K.bind(this),this.#j=this.#Q.bind(this),this.#z=this.#X.bind(this),this.#J=new w("password","view-password","reset-password")}initialize(){this.#f(),this.#v(),this.#J.initialize()}initializeSelectOptions(){if(null!=this.#M)for(const e of this.#V){const t=document.createElement("OPTION");t.value=e,t.setAttribute("data-i18n",this.#B[e]),this.#M.appendChild(t)}if(null!=this.#P)for(const e of this.#D.connectionAccounts){const t=document.createElement("OPTION");t.value=e.id,t.id=e.type,t.setAttribute("data-i18n",this.#T[e.type]),this.#P.appendChild(t)}}destroy(){this.#m(),this.#w(),this.#J.destroy()}setLocale(e){this.#J.setLocale(e)}show(){this.#Y(),this.#Z(this.#D),this.checkValid(),this.showForm()}showForm(){this.#b&&(this.#b.style.visibility="visible")}reset(){const e=this.#D.lang,t=this.#D.locale;this.startModel?this.#D=this.startModel.clone():this.#D=new m,this.#D.lang=e,this.#D.locale=t,this.#D.setCurrentCredentialToCredentialMap(),this.#Z(this.#D),this.checkValid()}backupModel(){this.startModel&&(this.startModel=null),this.startModel=Deep.deepFreeze(this.#D.clone())}checkValid(){let e=!0;if(this.#D.locale&&(null!=this.#C&&(this.#C.validity.valueMissing?(this.#C.setCustomValidity(this.#D.locale["Please enter the URL."]),e=!1):this.#C.validity.typeMismatch?this.#C.setCustomValidity(this.#D.locale["Please enter a valid URL."]):this.#C.setCustomValidity("")),"HttpAuth"===this.#D.credential.type&&(null!=this.#U&&(this.#U.validity.valueMissing?(this.#U.setCustomValidity(this.#D.locale["Please enter the identifier."]),e=!1):this.#U.setCustomValidity("")),e=e&&this.#J.checkValid()),this.#D.autorefreshUrlEnabled&&null!=this.#x))if(this.#x.validity.rangeUnderflow||this.#x.validity.rangeOverflow)try{const t=this.#x.min.split(/:/g),s=this.#x.max.split(/:/g),i=3600*parseInt(t[0],10)+60*parseInt(t[1],10)+parseInt(t[2]),n=3600*parseInt(s[0],10)+60*parseInt(s[1],10)+parseInt(s[2]),l={min:String(Math.floor(i/60)),max:String(Math.floor(n/3600))},r=this.resolveParams(this.#D.locale["Please enter a refresh period in the range of {{min}} minutes to {{max}} hours."],l);this.#x.setCustomValidity(r),e=!1}catch(e){this.#x.setCustomValidity("")}else this.#x.setCustomValidity("");return e}applyLanguage(){if(null!=this.#D.locale){const e=(e,t)=>{e.forEach((e=>{e instanceof HTMLInputElement&&"text"==e.type?e.value=t:e.textContent=t}))},t=(e,t)=>{e.forEach((e=>{e.hasAttribute("data-i18n-title")&&(e.title=t)}))};for(const s in this.#D.locale){const i=document.querySelectorAll(`[data-i18n="${s}"]`),n=document.querySelectorAll(`[data-i18n-title="${s}"]`),l=this.#D.locale[s];e(i,l),t(n,l)}}}resolveParams(e,t){const s=/{{(.+?)}}/g;if(t&&s.test(e)){const i=e.split(s);for(let s=i.length-1;s>=0;s--){const n=i[s];new RegExp("\\{\\{"+n.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&")+"\\}\\}","g").test(e)&&(t.hasOwnProperty(n)?i[s]=t[n]:i[s]="")}e=i.join("")}return e}hidePassword(){this.#D.hidePassword(),this.#ee()}#v(){null!=this.#P&&this.#P.addEventListener("change",this.#$),null!=this.#C&&this.#C.addEventListener("input",this.#F),null!=this.#M&&this.#M.addEventListener("change",this.#R),null!=this.#U&&this.#U.addEventListener("input",this.#q),null!=this.#S&&this.#S.addEventListener("click",this.#O),null!=this.#x&&this.#x.addEventListener("input",this.#j),null!=this.#k&&this.#k.addEventListener("click",this.#z),window.addEventListener(c,this.#o,!0)}#te(e){null!=this.#x&&(this.#x.disabled=!e,this.#x.required=e)}#f(){this.#b=document.getElementById("form"),this.#P=document.getElementById("connection-account"),this.#C=document.getElementById("url"),this.#A=document.getElementById("url-example"),this.#M=document.getElementById("credential"),this.#U=document.getElementById("username"),this.#L=document.getElementById("username-password"),this.#H=document.getElementById("none-crendential-info"),this.#S=document.getElementById("autorefresh-url-enabled"),this.#x=document.getElementById("autorefresh-url-interval"),this.#k=document.getElementById("start-after-boot-completed"),null!=this.#b&&(this.#b.style.visibility="hidden")}#K(e){if(null!=this.#S){const e=this.#S.checked;this.#D.autorefreshUrlEnabled=e,this.#te(e)}this.#se()}#Q(e){if(null!=this.#x)try{this.#D.autorefreshUrlInterval=Math.floor(this.#x.valueAsNumber)}catch(e){this.#D.autorefreshUrlInterval=6e4}this.#se()}#G(e){if(null!=this.#M){for(let e=this.#M.options.length-1;e>=0;e--)e!=this.#M.options.selectedIndex&&this.#M.options[e].removeAttribute("selected");null!=this.#D.credential.type?this.#M.options[this.#M.options.selectedIndex].setAttribute("selected","selected"):this.#M.selectedIndex=-1;let e=!1;const t=this.#M.value;if(this.#ie(t),this.#D.credential&&this.#D.oldCredentialMap.set(this.#D.credential.type,this.#D.credential),this.#D.oldCredentialMap.has(t)){const s=this.#D.oldCredentialMap.get(t);s?(this.#D.credential=s,"HttpAuth"===t?this.#J.setModel(this.#D.credential.password):this.#J.setModel(null)):e=!0}else e=!0;if(e){if("HttpAuth"===t)this.#D.credential={type:t,credential:"default",username:"",password:{crypted:!0,value:""}},this.#J.setModel(this.#D.credential.password);else this.#D.credential={type:t,credential:"default"},this.#J.setModel(null);this.#D.oldCredentialMap.set(t,this.#D.credential)}}this.#se()}#u(e){e instanceof CustomEvent&&this.#se()}#N(e){null!=this.#P&&(this.#D.connectionAccount=this.#P.value)}#_(e){null!=this.#C&&(this.#D.url=this.#C.value),this.#se()}#W(e){null!=this.#U&&(this.#D.credential.username=this.#U.value),this.#se()}#X(e){null!=this.#k&&(this.#D.startAfterBootCompleted=this.#k.checked),this.#se()}#m(){null!=this.#C&&this.#C.setCustomValidity(""),null!=this.#U&&this.#U.setCustomValidity(""),null!=this.#x&&this.#x.setCustomValidity("")}#ie(e){if("HttpAuth"===e)null!=this.#L&&(this.#L.style.display=""),null!=this.#U&&(this.#U.required=!0),this.#J.updateEditor(),null!=this.#H&&(this.#H.style.display="none");else null!=this.#U&&(this.#U.required=!1),this.#L&&(this.#L.style.display="none"),null!=this.#H&&(this.#H.style.display="")}#w(){null!=this.#P&&this.#P.removeEventListener("change",this.#$),null!=this.#C&&this.#C.removeEventListener("input",this.#F),null!=this.#M&&this.#M.removeEventListener("change",this.#R),null!=this.#U&&this.#U.removeEventListener("input",this.#q),null!=this.#S&&this.#S.removeEventListener("click",this.#O),null!=this.#S&&this.#S.removeEventListener("click",this.#O),null!=this.#x&&this.#x.removeEventListener("input",this.#j),null!=this.#k&&this.#k.removeEventListener("click",this.#z),window.addEventListener(c,this.#o,!0)}#Y(){null!=this.#A&&null!=this.#D.locale&&(this.#A.innerText=this.resolveParams(this.#D.locale["Example: {{value}}"],{value:this.#D.urlExample}))}#ee(e){e||(e=this.#D),null!=e.credential.password?this.#J.setModel(e.credential.password):this.#J.setModel({crypted:!1,value:""}),this.#J.updateEditor()}#Z(e){if(null!=this.#P&&(null!=e.connectionAccount?(this.#P.value=e.connectionAccount,this.#P.options[this.#P.options.selectedIndex].setAttribute("selected","selected")):this.#P.selectedIndex=-1),null!=this.#M&&(null!=e.credential.type?(this.#M.value=e.credential.type,this.#M.options[this.#M.options.selectedIndex].setAttribute("selected","selected")):this.#M.selectedIndex=-1),this.#ie(e.credential.type),null!=this.#S&&(this.#S.checked=e.autorefreshUrlEnabled,this.#te(e.autorefreshUrlEnabled)),null!=this.#x)try{this.#x.valueAsNumber=e.autorefreshUrlInterval}catch(t){e.autorefreshUrlInterval=6e4}null!=this.#M&&(this.#M.value=e.credential.type),null!=this.#U&&(this.#U.value=e.credential.username||""),this.#ee(e),this.#ie(e.credential.type),null!=this.#C&&(this.#C.value=e.url),null!=this.#k&&(this.#k.checked=e.startAfterBootCompleted)}#se(){this.startModel?this.isModified=!this.#D.equals(this.startModel):this.isModified=!0;const e=new CustomEvent(u,{detail:{modified:this.isModified,save:!1,valid:this.checkValid()}});window.dispatchEvent(e)}}class v{#D;#ne;#le;#re;#ae;#oe;#de;constructor(){this.#ae=this.#he.bind(this),this.#oe=this.#ue.bind(this),this.#de=this.#ce.bind(this),this.#D=new m,this.#ne=new f(this.#D),this.#pe()}initialize(){this.#me(),this.#v(),this.#ne.initialize(),this.#we(),this.#fe();const e=[];e.push(this.#ve()),e.push(this.#Ie()),e.push(this.#Ee()),Promise.all(e).then((()=>{this.#ne.initializeSelectOptions(),this.#ne.backupModel(),this.#ne.applyLanguage(),this.#ne.show()}),(e=>{this.#ne.showForm(),this.#ge(e)})).finally((()=>{this.#ye(),this.#be()}))}destroy(){this.#ne.destroy(),this.#w()}#ce(e,t){this.#pe(),this.#ve().then((()=>{this.#ne.applyLanguage()}),(()=>{}))}#v(){window.addEventListener(u,this.#ae,!0),window.addEventListener(p,this.#oe,!0)}#w(){window.removeEventListener(u,this.#ae,!0),window.removeEventListener(p,this.#oe,!0)}#ye(){null!=this.#le&&(clearTimeout(this.#le),this.#le=null)}#pe(){let{lang:e,dir:t}=window.parent.document.documentElement;if(e&&(document.documentElement.lang=e),t&&(document.documentElement.dir=t),this.#D.lang=document.documentElement.lang,!this.#D.lang||0===this.#D.lang.length)try{this.#D.lang=navigator.language}catch{}if(this.#D.lang){let e=this.#D.lang.split("-").map((e=>e.toLowerCase()));1===e.length&&("en"===e[0]?this.#D.lang="en-us":(e.push(e[0]),this.#D.lang=e.join("-")))}else this.#D.lang="en-us"}#Pe(e,t,s){return fetch(e,{mode:"same-origin",keepalive:!0,referrerPolicy:"same-origin",cache:"no-cache",method:t,body:s})}#Ce(e){return this.#Pe(e,"GET").then((e=>{if(e.ok)return e.json();throw e.status}))}#ve(){const e=`i18n/${this.#D.lang}/translation.json`;return this.#Ce(e).then((e=>{if(!e)throw"The label translations are empty";this.#D.locale=e,this.#ne.setLocale(e)})).catch((e=>{if("object"==typeof e)throw e.message;throw e}))}async#Ie(){try{const e=await this.#Ce(o);if(!e||0===Object.keys(e).length)throw this.#D&&this.#D.locale?this.#D.locale["The preferences are empty"]:"The preferences are empty";this.#D.parse(e,d);const{credential:t}=this.#D;if(null!=t.credential&&t.credential.length>0){const e=`${o}(${s}.${encodeURIComponent(t.credential)}.prefs`;try{if(t.type=(await this.#Ce(`${e}%2Ftype)`)).Value??"","native"===t.type&&(t.type="HttpAuth"),this.#D.oldCredentialMap.set(t.type,t),"HttpAuth"===t.type){const s=await this.#Ce(`${e}%2Fusername)`);t.username=s.Value??"",t.password={crypted:!0,value:""}}}catch{t.type="",delete t.username,delete t.password}}}catch(e){if("object"==typeof e)throw e.message;throw e}}#Ee(){const e=[{type:"web-site",id:(()=>{let e=(new Date).getTime();return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(t){const s=(e+16*Math.random())%16|0;return e=Math.floor(e/16),("x"==t?s:3&s|8).toString(16)}))})(),supportedCapabilities:["web-site"],credential:{type:"",credential:""}}];return this.#D.connectionAccounts=e,Promise.resolve()}#we(){this.#le=window.setTimeout((()=>{this.#be(),this.#le=null}),3e4)}#fe(){this.#re=new MutationObserver(this.#de),this.#re.observe(window.parent.document.documentElement,{attributeFilter:["lang","dir"],attributes:!0,characterData:!1,childList:!1,subtree:!1})}#he(e){if(e instanceof CustomEvent){const t=e.detail;null!=t&&window.parent.postMessage(t,"*")}}#ue(e){if(e instanceof MessageEvent){const t=e.data;"save"in t&&this.#Ae(),"cancel"in t&&(this.#Me(),window.parent.postMessage({modified:!1,saved:!1,valid:!0},"*"))}}#Ae(){this.#we(),this.#Ue().then((e=>{e.every((e=>e>=200&&e<300))&&(window.parent.postMessage({modified:!1,needReboot:!0,saved:!0,valid:!0},"*"),this.#ne.hidePassword(),this.#ne.backupModel())}),(e=>{this.#Le(e)})).finally((()=>{this.#ye(),this.#be()}))}#Ue(){const e=[];return null!=this.#ne.startModel&&(this.#D.startAfterBootCompleted!=this.#ne.startModel.startAfterBootCompleted&&e.push(this.#He(i)),this.#D.autorefreshUrlEnabled!=this.#ne.startModel.autorefreshUrlEnabled&&e.push(this.#He(n)),this.#D.autorefreshUrlInterval!=this.#ne.startModel.autorefreshUrlInterval&&e.push(this.#He(l)),this.#D.url!=this.#ne.startModel.url&&e.push(this.#He(r)),this.#D.credential.credential!=this.#ne.startModel.credential.credential&&e.push(this.#He(a)),this.#D.credential.type!=this.#ne.startModel.credential.type&&e.push(this.#He(`${s}.${this.#D.credential.credential}.prefs/type`)),this.#D.isUsernameChanged(this.#ne.startModel)&&e.push(this.#He(`${s}.${this.#D.credential.credential}.prefs/username`)),this.#D.isPasswordChanged()&&e.push(this.#He(`${s}.${this.#D.credential.credential}.prefs/password`))),Promise.all(e)}#me(){window.parent.postMessage({loading:!0},"*")}#be(){window.parent.postMessage({loading:!1},"*")}#ge(e){if("number"==typeof e)window.parent.postMessage({loadingError:`HTTP ${e}`},"*");else if("string"==typeof e&&e)window.parent.postMessage({loadingError:e},"*");else if(e)window.parent.postMessage({loadingError:JSON.stringify(e)},"*");else{const e=this.#D&&this.#D.locale&&this.#D.locale.miscellaneous?this.#D.locale.miscellaneous:"miscellaneous";window.parent.postMessage({loadingError:e},"*")}}#Le(e){if("number"==typeof e)window.parent.postMessage({savedError:`HTTP ${e}`},"*");else if("string"==typeof e&&e)window.parent.postMessage({savedError:e},"*");else if(e)window.parent.postMessage({savedError:JSON.stringify(e)},"*");else{const e=this.#D&&this.#D.locale&&this.#D.locale.miscellaneous?this.#D.locale.miscellaneous:"miscellaneous";window.parent.postMessage({savedError:e},"*")}}#He(e){const t=encodeURIComponent(e),s=`${o}(${t})`,i=JSON.stringify(this.#D.getJsonPref(e));return this.#Pe(s,"PATCH",i).then((e=>{if(e.ok)return e.status;throw e.status})).catch((e=>{if("object"==typeof e)throw e.message;throw e}))}#Me(){this.#ne.reset()}}var I;window.addEventListener("load",(function(){(I=new v).initialize()})),window.addEventListener("unload",(function(){I.destroy()}))})();